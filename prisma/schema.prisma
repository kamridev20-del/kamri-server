generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String?
  firstName    String?
  lastName     String?
  phone        String?
  address      String?
  password     String
  role         String        @default("user")
  status       String        @default("active")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  addresses    Address[]
  cart         CartItem[]
  orders       Order[]
  reviews      Review[]
  userSettings UserSettings?
  wishlist     Wishlist[]

  @@index([email])
  @@map("users")
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  nameEn      String?
  description String?
  icon        String?   @default("üõçÔ∏è")
  color       String?   @default("#4CAF50")
  externalId  String?
  parentId    String?
  level       Int?
  isActive    Boolean   @default(true)
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  imageUrl    String?
  products    Product[]

  @@index([name])
  @@index([parentId])
  @@map("categories")
}

model Product {
  id                String            @id @default(cuid())
  name              String
  description       String?
  // ‚úÖ Champs multilingues (FR/EN)
  name_fr           String?
  name_en           String?
  description_fr    String?           @db.Text
  description_en    String?           @db.Text
  price             Float
  originalPrice     Float?
  image             String?
  categoryId        String?
  supplierId        String?
  externalCategory  String?
  source            String?
  status            String            @default("pending")
  badge             String?
  stock             Int               @default(0)
  sales             Int               @default(0)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  cjProductId       String?           @unique
  productSku        String?
  productWeight     String?
  packingWeight     String?
  productType       String?
  productUnit       String?
  productKeyEn      String?
  materialNameEn    String?
  packingNameEn     String?
  suggestSellPrice  String?
  listedNum         Int?
  supplierName      String?
  createrTime       String?
  variants          String?
  cjReviews         String?
  dimensions        String?
  brand             String?
  tags              String?
  importStatus      String?           @default("new")
  lastImportAt      DateTime?
  margin            Float?
  isEdited          Boolean           @default(false)
  editedAt          DateTime?
  editedBy          String?
  originCountryCode String?           @default("CN")
  originWarehouseId String?
  rating            Float?
  reviewsCount      Int?              @default(0)
  productVideo      String? // ‚úÖ Vid√©o du produit (JSON avec videoList)
  cartItems         CartItem[]
  cjMapping         CJProductMapping?
  images            Image[]
  orderItems        OrderItem[]
  productVariants   ProductVariant[]
  category          Category?         @relation(fields: [categoryId], references: [id])
  supplier          Supplier?         @relation(fields: [supplierId], references: [id])
  reviews           Review[]
  wishlist          Wishlist[]

  @@index([categoryId])
  @@index([supplierId])
  @@index([status])
  @@index([cjProductId])
  @@index([name])
  @@map("products")
}

model ProductVariant {
  id          String      @id @default(cuid())
  productId   String
  cjVariantId String?     @unique
  name        String?
  sku         String?
  price       Float?
  weight      Float?
  dimensions  String?
  image       String?
  status      String?
  properties  String?
  stock       Int?
  isActive    Boolean     @default(true)
  lastSyncAt  DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  orderItems  OrderItem[]
  cartItems   CartItem[]
  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([cjVariantId])
  @@index([productId])
  @@map("product_variants")
}

model Image {
  id        String   @id @default(cuid())
  url       String
  alt       String?
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("images")
}

model CartItem {
  id             String          @id @default(cuid())
  userId         String
  productId      String
  variantId      String? // ID du variant choisi (optionnel)
  variantDetails Json? // D√©tails du variant (taille, couleur, etc.) au format JSON
  quantity       Int             @default(1)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  variant        ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@index([variantId])
  @@map("cart_items")
}

model Order {
  id              String          @id @default(cuid())
  userId          String
  total           Float
  status          String          @default("PENDING")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  paymentIntentId String?
  paymentStatus   String?
  paymentMethod   String?
  refundId        String?
  refundAmount    Float?
  refundedAt      DateTime?
  refundReason    String?
  shippingAddress String?
  shippingMethod  String?
  shippingCost    Float?
  cjMapping       CJOrderMapping?
  items           OrderItem[]
  user            User            @relation(fields: [userId], references: [id])

  @@index([paymentIntentId])
  @@index([paymentStatus])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id        String          @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float
  variantId String?
  createdAt DateTime        @default(now())
  order     Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product         @relation(fields: [productId], references: [id])
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  street    String
  city      String
  state     String
  zipCode   String
  country   String   @default("US")
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  productId String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@index([rating])
  @@map("reviews")
}

model Supplier {
  id                 String                     @id @default(cuid())
  name               String                     @unique
  description        String?
  apiUrl             String
  apiKey             String
  status             String                     @default("disconnected")
  lastSync           DateTime?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  categoryMappings   CategoryMapping[]
  products           Product[]
  unmappedCategories UnmappedExternalCategory[]

  @@index([name])
  @@map("suppliers")
}

model CategoryMapping {
  id               String   @id @default(cuid())
  supplierId       String
  externalCategory String
  internalCategory String
  status           String   @default("mapped")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  supplier         Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([supplierId, externalCategory])
  @@index([supplierId])
  @@map("category_mappings")
}

model UnmappedExternalCategory {
  id               String   @id @default(cuid())
  externalCategory String
  supplierId       String
  detectedAt       DateTime @default(now())
  productCount     Int      @default(0)
  supplier         Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([supplierId, externalCategory])
  @@index([supplierId])
  @@map("unmapped_external_categories")
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@map("wishlist")
}

model Settings {
  id                 String   @id @default(cuid())
  theme              String   @default("light")
  currency           String   @default("EUR")
  language           String   @default("fr")
  accentColor        String   @default("#4CAF50")
  companyName        String   @default("KAMRI")
  companyEmail       String?
  companyPhone       String?
  companyAddress     String?
  apiRateLimit       Int      @default(1000)
  autoSync           Boolean  @default(true)
  notifications      Boolean  @default(true)
  emailNotifications Boolean  @default(true)
  smsNotifications   Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("settings")
}

model UserSettings {
  id            String   @id @default(cuid())
  userId        String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  notifications String   @default("{\"email\": true, \"sms\": false, \"push\": true, \"marketing\": false}")
  privacy       String   @default("{\"profileVisible\": true, \"orderHistory\": false, \"dataSharing\": false}")
  preferences   String   @default("{\"theme\": \"light\", \"language\": \"fr\", \"currency\": \"EUR\"}")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_settings")
}

model CJConfig {
  id             String    @id @default(cuid())
  email          String
  apiKey         String
  tier           String    @default("free")
  platformToken  String?
  enabled        Boolean   @default(true)
  accessToken    String?
  refreshToken   String?
  tokenExpiry    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  webhookEnabled Boolean?  @default(false)
  webhookUrl     String?
  webhookTypes   String?

  @@index([email])
  @@map("cj_configs")
}

model CJProductStore {
  id                    String   @id @default(cuid())
  cjProductId           String   @unique
  name                  String
  description           String?
  price                 Float
  originalPrice         Float?
  image                 String?
  category              String?
  status                String   @default("available")
  isFavorite            Boolean  @default(false)
  importStatus          String   @default("not_imported")
  importedProductId     String?
  productSku            String?
  productWeight         String?
  packingWeight         String?
  productType           String?
  productUnit           String?
  productKeyEn          String?
  materialNameEn        String?
  packingNameEn         String?
  suggestSellPrice      String?
  listedNum             Int?
  supplierName          String?
  supplierId            String?
  createrTime           String?
  variants              String?
  reviews               String?
  dimensions            String?
  brand                 String?
  tags                  String?
  categoryId            String?
  entryCode             String?
  entryName             String?
  entryNameEn           String?
  materialName          String?
  materialKey           String?
  packingName           String?
  packingKey            String?
  productKey            String?
  productProSet         String?
  productProEnSet       String?
  customizationVersion  Int?
  customizationJson1    String?
  customizationJson2    String?
  customizationJson3    String?
  customizationJson4    String?
  productVideo          String?
  deliveryCycle         String?
  isFreeShipping        Boolean?
  freeShippingCountries String?
  defaultShippingMethod String?
  productProperty1      String?  @map("product_property1")
  productProperty2      String?  @map("product_property2")
  productProperty3      String?  @map("product_property3")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([cjProductId])
  @@index([status])
  @@index([isFavorite])
  @@map("cj_product_store")
}

model CJProductMapping {
  id          String    @id @default(cuid())
  productId   String    @unique
  cjProductId String
  cjSku       String
  lastSyncAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([cjProductId])
  @@index([productId])
  @@map("cj_product_mappings")
}

model CJOrderMapping {
  id            String   @id @default(cuid())
  orderId       String   @unique
  cjOrderId     String
  cjOrderNumber String
  status        String
  trackNumber   String?
  metadata      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([cjOrderId])
  @@index([status])
  @@index([orderId])
  @@map("cj_order_mappings")
}

model WebhookLog {
  id               String    @id @default(cuid())
  messageId        String    @unique
  type             String
  payload          String
  status           String    @default("RECEIVED")
  result           String?
  error            String?
  processingTimeMs Int?
  receivedAt       DateTime  @default(now())
  processedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([type, status])
  @@index([receivedAt])
  @@index([messageId])
  @@map("webhook_logs")
}

model CJWebhookLog {
  id        String   @id @default(cuid())
  type      String
  messageId String   @unique
  payload   String
  processed Boolean  @default(false)
  error     String?
  createdAt DateTime @default(now())
  action    String?  @default("pending")

  @@index([type, processed])
  @@index([messageId])
  @@index([type, action])
  @@map("cj_webhook_logs")
}

model ProductUpdateNotification {
  id               String    @id @default(cuid())
  productId        String?
  cjProductId      String
  cjVariantId      String?
  webhookType      String
  webhookMessageId String
  changes          String?
  productName      String?
  isRead           Boolean   @default(false)
  createdAt        DateTime  @default(now())
  readAt           DateTime?

  @@index([isRead, createdAt])
  @@index([productId])
  @@index([cjProductId])
  @@map("product_update_notifications")
}

model CJSourcingRequest {
  id                String    @id @default(cuid())
  cjSourcingId      String?   @unique
  sourceNumber      String?
  thirdProductId    String?
  thirdVariantId    String?
  thirdProductSku   String?
  productName       String
  productImage      String
  productUrl        String?
  price             Float?
  remark            String?
  status            String    @default("pending")
  statusChinese     String?
  cjProductId       String?
  cjVariantSku      String?
  imported          Boolean   @default(false)
  importedProductId String?
  shopId            String?
  shopName          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastCheckedAt     DateTime?
  foundAt           DateTime?

  @@index([status])
  @@index([cjSourcingId])
  @@index([imported])
  @@map("cj_sourcing_requests")
}

model SearchHistory {
  id             String   @id @default(cuid())
  query          String   @unique
  count          Int      @default(1)
  lastSearchedAt DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([count])
  @@index([lastSearchedAt])
  @@map("search_history")
}

model ExchangeRate {
  id        String   @id @default(cuid())
  currency  String   @unique
  rate      Float
  updatedat DateTime @default(now()) @map("updatedat")

  @@index([currency])
  @@map("exchange_rates")
}

model Visit {
  id          String   @id @default(cuid())
  ip          String?
  countryCode String
  countryName String
  city        String?
  region      String?
  userAgent   String?  @db.Text
  path        String?  // Page visit√©e (ex: /products, /categories)
  referer     String?  @db.Text
  language    String?  // Langue du navigateur
  isAuthenticated Boolean @default(false)
  userId      String?  // ID utilisateur si connect√©
  createdAt   DateTime @default(now())

  @@index([countryCode])
  @@index([createdAt])
  @@index([countryCode, createdAt])
  @@index([userId])
  @@map("visits")
}
